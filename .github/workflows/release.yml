name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (e.g. v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  BIN_NAME: jsonsheet

jobs:
  metadata:
    name: Resolve Release Metadata
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      tag_ref: ${{ steps.meta.outputs.tag_ref }}
      tag_sha: ${{ steps.meta.outputs.tag_sha }}
    steps:
      - name: Checkout repository with tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag
        id: meta
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="${{ inputs.tag }}"
          fi

          if [[ -z "${TAG}" ]]; then
            echo "Release tag is required." >&2
            exit 1
          fi

          if ! git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            git fetch --tags origin
          fi

          if ! git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag '${TAG}' was not found in the repository." >&2
            exit 1
          fi

          TAG_SHA="$(git rev-list -n 1 "refs/tags/${TAG}")"

          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "tag_ref=refs/tags/${TAG}" >> "${GITHUB_OUTPUT}"
          echo "tag_sha=${TAG_SHA}" >> "${GITHUB_OUTPUT}"

  build:
    name: Build & Package (${{ matrix.os }})
    needs: metadata
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_suffix: windows-x86_64
          - os: ubuntu-latest
            artifact_suffix: linux-x86_64
          - os: macos-latest
            artifact_suffix: macos-x86_64

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.metadata.outputs.tag_ref }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: release-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: release-${{ runner.os }}-cargo-

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev libxdo-dev

      - name: Build release binary
        run: cargo build --release

      - name: Package release artifact
        id: package
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ needs.metadata.outputs.tag }}"
          SUFFIX="${{ matrix.artifact_suffix }}"
          BASE="${BIN_NAME}-${TAG}-${SUFFIX}"
          STAGE_DIR="release-stage"

          rm -rf "${STAGE_DIR}"
          mkdir -p "${STAGE_DIR}"

          cp README.md "${STAGE_DIR}/README.md"
          cp LICENSE "${STAGE_DIR}/LICENSE"

          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            cp "target/release/${BIN_NAME}.exe" "${STAGE_DIR}/${BIN_NAME}.exe"
            ARCHIVE="${BASE}.zip"
            pwsh -NoProfile -Command "Compress-Archive -Path '${STAGE_DIR}/*' -DestinationPath '${ARCHIVE}' -Force"
          else
            cp "target/release/${BIN_NAME}" "${STAGE_DIR}/${BIN_NAME}"
            ARCHIVE="${BASE}.tar.gz"
            tar -czf "${ARCHIVE}" -C "${STAGE_DIR}" .
          fi

          echo "archive=${ARCHIVE}" >> "${GITHUB_OUTPUT}"

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.archive }}
          path: ${{ steps.package.outputs.archive }}
          if-no-files-found: error

  publish:
    name: Publish GitHub Release
    needs: [metadata, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.metadata.outputs.tag }}
          name: JsonSheet ${{ needs.metadata.outputs.tag }}
          target_commitish: ${{ needs.metadata.outputs.tag_sha }}
          generate_release_notes: true
          files: dist/*
          fail_on_unmatched_files: true
